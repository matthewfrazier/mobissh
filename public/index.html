<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#1a1a2e" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>MobiSSH</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Fira+Code:wght@400;700&display=swap" />
  <link rel="stylesheet" href="app.css" />

  <!-- xterm.js via CDN ‚Äî no build step needed for POC -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <!-- WebLinksAddon removed: breaks wrapped URLs (issue #50) -->
</head>
<body>
  <!-- Hidden IME input field ‚Äî captures Android swipe/voice without Web Speech API -->
  <!--
    This textarea is positioned off-screen and always focused when the terminal is active.
    Android's IME fires standard `input` events here for swipe-typed words and voice text.
    We forward those events to the SSH stream. No Web Speech API required.
  -->
  <textarea
    id="imeInput"
    aria-label="SSH keyboard input"
    autocomplete="off"
    autocorrect="off"
    autocapitalize="off"
    spellcheck="false"
    tabindex="-1"
  ></textarea>
  <!-- Direct-mode input: type="password" suppresses Gboard swipe and autocorrect (#44/#48) -->
  <input
    id="directInput"
    type="password"
    aria-label="SSH direct key input"
    autocomplete="off"
    data-lpignore="true"
    data-1p-ignore="true"
    data-form-type="other"
    tabindex="-1"
  />

  <div id="app">
    <!-- Tab bar -->
    <nav id="tabBar">
      <button class="tab active" data-panel="terminal" aria-label="Terminal">
        <span class="tab-icon">‚å®</span>
        <span class="tab-label">Terminal</span>
      </button>
      <button class="tab" data-panel="connect" aria-label="Connect">
        <span class="tab-icon">‚ö°</span>
        <span class="tab-label">Connect</span>
      </button>
      <button class="tab" data-panel="keys" aria-label="Keys">
        <span class="tab-icon">üîë</span>
        <span class="tab-label">Keys</span>
      </button>
      <button class="tab" data-panel="settings" aria-label="Settings">
        <span class="tab-icon">‚öô</span>
        <span class="tab-label">Settings</span>
      </button>
    </nav>

    <!-- Terminal panel -->
    <div id="panel-terminal" class="panel active">
      <div id="terminal"></div>
      <!-- IME composition preview ‚Äî shows word being composed before commit (#44) -->
      <div id="imePreview" class="hidden" aria-live="polite" aria-atomic="true"></div>
      <!-- Handle strip: ‚â° tab toggle | session identity (center) | ‚ñæ key bar toggle -->
      <div id="key-bar-handle" aria-label="Terminal controls">
        <button id="tabBarToggleBtn" title="Show navigation tabs" aria-label="Show navigation">‚â°</button>
        <button id="sessionMenuBtn" title="Session menu" aria-label="Session menu">MobiSSH</button>
        <span id="handleChevron" title="Toggle key bar" role="button" aria-label="Toggle key bar">‚ñæ</span>
        <!-- Session menu anchored inside the positioned parent so absolute positioning works -->
        <div id="sessionMenu" class="hidden" role="menu">
          <div class="session-menu-item font-size-row" role="menuitem">
            <button id="fontDecBtn"   class="font-adj-btn" title="Decrease font size">A‚àí</button>
            <span   id="fontSizeLabel">14px</span>
            <button id="fontIncBtn"   class="font-adj-btn" title="Increase font size">A+</button>
          </div>
          <button id="sessionCopyBtn"       class="session-menu-item" role="menuitem">Copy selection</button>
          <button id="sessionResetBtn"      class="session-menu-item" role="menuitem">Reset terminal</button>
          <button id="sessionClearBtn"      class="session-menu-item" role="menuitem">Clear scrollback</button>
          <button id="sessionRecordStartBtn" class="session-menu-item rec-start" role="menuitem">‚óè Start Recording</button>
          <button id="sessionRecordStopBtn"  class="session-menu-item rec-stop hidden" role="menuitem">‚ñ† Stop &amp; Download</button>
          <button id="sessionCtrlCBtn"      class="session-menu-item" role="menuitem">Send Ctrl+C</button>
          <button id="sessionCtrlZBtn"      class="session-menu-item" role="menuitem">Send Ctrl+Z</button>
          <button id="sessionThemeBtn"      class="session-menu-item" role="menuitem">Theme: Dark ‚ñ∏</button>
          <button id="sessionReconnectBtn"  class="session-menu-item" role="menuitem">Reconnect</button>
          <button id="sessionDisconnectBtn" class="session-menu-item danger" role="menuitem">Disconnect</button>
        </div>
      </div>
      <div id="key-bar">
        <!-- Single row: scrollable special keys + right-anchored IME toggle -->
        <div id="key-keys-row">
          <div id="key-scroll">
            <button id="keyEsc"   class="key-btn" title="Escape">Esc</button>
            <button id="keyCtrl"  class="key-btn modifier" title="Ctrl modifier">Ctl</button>
            <button id="keyTab"   class="key-btn" title="Tab">‚Üπ</button>
            <button id="keySlash" class="key-btn" title="/">/</button>
            <button id="keyPipe"  class="key-btn" title="|">|</button>
            <button id="keyDash"  class="key-btn" title="-">-</button>
            <button id="keyBksp"  class="key-btn" title="Backspace / long-press: word erase">‚å´</button>
            <button id="keyUp"    class="key-btn" title="Up">‚ñ≤</button>
            <button id="keyDown"  class="key-btn" title="Down">‚ñº</button>
            <button id="keyLeft"  class="key-btn" title="Left">‚óÄ</button>
            <button id="keyRight" class="key-btn" title="Right">‚ñ∂</button>
            <button id="keyHome"  class="key-btn" title="Home">Home</button>
            <button id="keyEnd"   class="key-btn" title="End">End</button>
            <button id="keyPgUp"  class="key-btn" title="Page Up">PgUp</button>
            <button id="keyPgDn"  class="key-btn" title="Page Down">PgDn</button>
          </div>
          <button id="keyModeBtn" class="key-btn mode-btn" title="Toggle IME / direct key entry">IME</button>
        </div>
      </div>
    </div>

    <!-- Connect panel -->
    <div id="panel-connect" class="panel">
      <h2>Connect</h2>

      <form id="connectForm" autocomplete="off">
        <label for="profileName">Profile name</label>
        <input type="text" id="profileName" placeholder="My Server" />

        <label for="host">Host</label>
        <input type="text" id="host" placeholder="192.168.1.100" required inputmode="url" />

        <label for="port">Port</label>
        <input type="number" id="port" value="22" min="1" max="65535" inputmode="numeric" />

        <label for="username">Username</label>
        <input type="text" id="username" placeholder="root" required autocapitalize="none" />

        <label for="authType">Auth method</label>
        <select id="authType">
          <option value="password">Password</option>
          <option value="key">Private key</option>
        </select>

        <div id="passwordGroup">
          <label for="password">Password</label>
          <input type="password" id="password"
            autocomplete="new-password"
            data-lpignore="true"
            data-1p-ignore
            data-form-type="other" />
        </div>

        <div id="keyGroup" style="display:none">
          <label for="privateKey">Private key</label>
          <textarea id="privateKey" rows="4" placeholder="Paste PEM private key here..." spellcheck="false"></textarea>
          <label for="passphrase">Passphrase (if encrypted)</label>
          <input type="password" id="passphrase"
            autocomplete="new-password"
            data-lpignore="true"
            data-1p-ignore
            data-form-type="other" />
          <button type="button" id="useStoredKeyBtn" class="secondary-btn">Use stored key‚Ä¶</button>
        </div>

        <label for="initialCommand">Initial command (optional)</label>
        <input type="text" id="initialCommand"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="none"
          spellcheck="false" />
        <p class="hint">Runs automatically after connecting. Leave blank for a normal shell.</p>

        <button type="submit" class="primary-btn">Connect</button>
      </form>

      <h3>Saved profiles</h3>
      <div id="profileList" class="item-list">
        <p class="empty-hint">No saved profiles yet.</p>
      </div>
    </div>

    <!-- Keys panel -->
    <div id="panel-keys" class="panel">
      <h2>SSH Keys</h2>
      <p class="hint">Import your private keys here. They are stored in your browser's localStorage.
         Do not use this on a shared device.</p>

      <div class="form-section">
        <label for="keyName">Key name</label>
        <input type="text" id="keyName" placeholder="my-key" />

        <label for="keyData">Private key (PEM)</label>
        <textarea id="keyData" rows="6" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" spellcheck="false"></textarea>

        <button id="importKeyBtn" class="primary-btn">Save key</button>
      </div>

      <h3>Stored keys</h3>
      <div id="keyList" class="item-list">
        <p class="empty-hint">No keys stored.</p>
      </div>
    </div>

    <!-- Settings panel -->
    <div id="panel-settings" class="panel">
      <h2>Settings</h2>

      <label for="wsUrl">WebSocket server URL</label>
      <input type="url" id="wsUrl" placeholder="ws://localhost:8080" inputmode="url" />
      <p class="hint">The URL of your ssh-bridge server. Use <code>wss://</code> for secure connections.
         When running in a Codespace, set this to the forwarded port URL for port 8080 with <code>wss://</code>.</p>
      <button id="saveSettingsBtn" class="primary-btn">Save</button>

      <hr />

      <label for="fontSize">Terminal font size</label>
      <input type="range" id="fontSize" min="10" max="24" value="14" />
      <span id="fontSizeValue">14px</span>

      <hr />

      <label for="termThemeSelect">Default terminal theme</label>
      <select id="termThemeSelect">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="solarizedDark">Solarized Dark</option>
        <option value="solarizedLight">Solarized Light</option>
        <option value="highContrast">High Contrast</option>
      </select>
      <p class="hint">Persisted across sessions. Use the session menu to switch themes temporarily during a session.</p>

      <hr />

      <label for="termFontSelect">Terminal font</label>
      <select id="termFontSelect">
        <option value="jetbrains">'JetBrains Mono'</option>
        <option value="firacode">'Fira Code'</option>
        <option value="monospace">System monospace</option>
      </select>
      <p class="hint">Requires page reload to take effect.</p>

      <hr />

      <button id="clearDataBtn" class="danger-btn">Clear all data (keys, profiles, settings)</button>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
