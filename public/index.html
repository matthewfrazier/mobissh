<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1a1a2e" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>MobiSSH</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.svg" />
  <link rel="stylesheet" href="app.css" />

  <!-- xterm.js ‚Äî bundled locally to avoid CDN dependency / CSP proxy conflicts -->
  <link rel="stylesheet" href="vendor/xterm.min.css" />
  <script src="vendor/xterm.min.js"></script>
  <script src="vendor/xterm-addon-fit.min.js"></script>
</head>
<body>
  <!-- Recovery overlay ‚Äî displayed by the boot watchdog when the app fails to init.
       Inline styles are intentional: this must render even if app.css fails to load. -->
  <div id="recovery-overlay"
       role="alertdialog"
       aria-live="assertive"
       aria-label="App failed to start"
       style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#0d0d1a;color:#e0e0e0;flex-direction:column;align-items:center;justify-content:center;z-index:9999;font-family:system-ui,-apple-system,sans-serif;text-align:center;padding:24px;box-sizing:border-box;">
    <h2 style="color:#ff4444;margin-bottom:12px;font-size:20px">App failed to start</h2>
    <p style="color:#888;margin-bottom:32px;max-width:320px;line-height:1.5">
      The app could not initialize. This is usually caused by a stale cached
      version or a missing resource.
    </p>
    <button id="recovery-reset-btn"
            style="background:#00ff88;color:#0d0d1a;border:none;padding:14px 32px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;margin-bottom:16px;-webkit-tap-highlight-color:transparent">
      Reset App
    </button>
    <p style="color:#555;font-size:13px">Clears the app cache and reloads.</p>
  </div>

  <!-- Hidden IME input field ‚Äî captures Android swipe/voice without Web Speech API -->
  <!--
    This textarea is positioned off-screen and always focused when the terminal is active.
    Android's IME fires standard `input` events here for swipe-typed words and voice text.
    We forward those events to the SSH stream. No Web Speech API required.
  -->
  <textarea
    id="imeInput"
    aria-label="SSH keyboard input"
    autocomplete="off"
    autocorrect="off"
    autocapitalize="off"
    spellcheck="false"
    tabindex="-1"
  ></textarea>
  <!-- Direct-mode input: type="password" suppresses Gboard swipe and autocorrect (#44/#48) -->
  <input
    id="directInput"
    type="password"
    aria-label="SSH direct key input"
    autocomplete="off"
    data-lpignore="true"
    data-1p-ignore="true"
    data-form-type="other"
    tabindex="-1"
  />

  <!-- Vault setup modal ‚Äî master password creation (first launch) -->
  <div id="vaultSetupOverlay" class="vault-overlay hidden" role="dialog" aria-label="Set up vault">
    <div class="vault-dialog">
      <h3 class="vault-title">Set a master password</h3>
      <p class="vault-desc">This password encrypts your saved credentials. You'll need it each time you open MobiSSH.</p>
      <input type="text" id="vaultUsername" autocomplete="username"
        value="MobiSSH Vault" tabindex="-1"
        aria-hidden="true" class="vault-hidden-username" />
      <label for="vaultNewPw" class="vault-label">Password</label>
      <input type="password" id="vaultNewPw" autocomplete="new-password"
        autocorrect="off" autocapitalize="off" spellcheck="false"
        data-lpignore="true" data-1p-ignore="true" data-form-type="other" />
      <div id="vaultStrength" class="vault-strength"></div>
      <label for="vaultConfirmPw" class="vault-label">Confirm password</label>
      <input type="password" id="vaultConfirmPw" autocomplete="new-password"
        autocorrect="off" autocapitalize="off" spellcheck="false"
        data-lpignore="true" data-1p-ignore="true" data-form-type="other" />
      <p id="vaultPwError" class="vault-error hidden"></p>
      <div id="vaultBioOption" class="vault-bio-option hidden">
        <label class="toggle vault-bio-toggle" aria-label="Enable fingerprint unlock">
          <span class="vault-bio-label">Enable fingerprint unlock</span>
          <input type="checkbox" id="vaultEnableBio" checked />
          <span class="toggle-slider toggle-slider-accent"></span>
        </label>
      </div>
      <div class="vault-buttons">
        <button id="vaultSetupCancel" class="vault-btn vault-btn-cancel">Cancel</button>
        <button id="vaultSetupCreate" class="vault-btn vault-btn-create">Create Vault</button>
      </div>
    </div>
  </div>

  <!-- Vault unlock prompt ‚Äî inline password entry when vault is locked -->
  <div id="vaultUnlockBar" class="vault-unlock-bar hidden">
    <input type="password" id="vaultUnlockPw" placeholder="Master password"
      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
      data-lpignore="true" data-1p-ignore="true" data-form-type="other" />
    <button id="vaultUnlockBtn" class="vault-unlock-btn">Unlock</button>
    <p id="vaultUnlockError" class="vault-unlock-error hidden">Wrong password</p>
  </div>

  <!-- Vault change password modal -->
  <div id="vaultChangePwOverlay" class="vault-overlay hidden" role="dialog" aria-label="Change master password">
    <div class="vault-dialog">
      <h3 class="vault-title">Change master password</h3>
      <label for="vaultOldPw" class="vault-label">Current password</label>
      <input type="password" id="vaultOldPw" autocomplete="off"
        autocorrect="off" autocapitalize="off" spellcheck="false"
        data-lpignore="true" data-1p-ignore="true" data-form-type="other" />
      <label for="vaultChangePwNew" class="vault-label">New password</label>
      <input type="password" id="vaultChangePwNew" autocomplete="new-password"
        autocorrect="off" autocapitalize="off" spellcheck="false"
        data-lpignore="true" data-1p-ignore="true" data-form-type="other" />
      <label for="vaultChangePwConfirm" class="vault-label">Confirm new password</label>
      <input type="password" id="vaultChangePwConfirm" autocomplete="new-password"
        autocorrect="off" autocapitalize="off" spellcheck="false"
        data-lpignore="true" data-1p-ignore="true" data-form-type="other" />
      <p id="vaultChangePwError" class="vault-error hidden"></p>
      <div class="vault-buttons">
        <button id="vaultChangePwCancel" class="vault-btn vault-btn-cancel">Cancel</button>
        <button id="vaultChangePwSave" class="vault-btn vault-btn-create">Save</button>
      </div>
    </div>
  </div>

  <div id="menuBackdrop" class="hidden"></div>
  <div id="app">
    <!-- Tab bar -->
    <nav id="tabBar">
      <button class="tab active" data-panel="terminal" aria-label="Terminal">
        <span class="tab-icon">‚å®</span>
        <span class="tab-label">Terminal</span>
      </button>
      <button class="tab" data-panel="connect" aria-label="Connect">
        <span class="tab-icon">‚ö°</span>
        <span class="tab-label">Connect</span>
      </button>
      <button class="tab" data-panel="keys" aria-label="Keys">
        <span class="tab-icon">üîë</span>
        <span class="tab-label">Keys</span>
      </button>
      <button class="tab" data-panel="settings" aria-label="Settings">
        <span class="tab-icon">‚öô</span>
        <span class="tab-label">Settings</span>
      </button>
    </nav>

    <!-- Terminal panel -->
    <div id="panel-terminal" class="panel active">
      <div id="terminal">
      </div>
      <!-- IME composition preview ‚Äî shows word being composed before commit (#44) -->
      <div id="imePreview" class="hidden" aria-live="polite" aria-atomic="true"></div>
      <!-- Handle strip: ‚â° tab toggle | session identity (center) | ‚ñæ key bar toggle -->
      <div id="key-bar-handle" aria-label="Terminal controls">
        <button id="tabBarToggleBtn" title="Show navigation tabs" aria-label="Show navigation">‚â°</button>
        <button id="sessionMenuBtn" title="Session menu" aria-label="Session menu">MobiSSH</button>
        <span id="handleChevron" title="Toggle key bar" role="button" aria-label="Toggle key bar">‚ñæ</span>
        <!-- Session menu anchored inside the positioned parent so absolute positioning works -->
        <div id="sessionMenu" class="hidden" role="menu">
          <div class="session-menu-item font-size-row" role="menuitem">
            <button id="fontDecBtn"   class="font-adj-btn" title="Decrease font size">A‚àí</button>
            <span   id="fontSizeLabel">14px</span>
            <button id="fontIncBtn"   class="font-adj-btn" title="Increase font size">A+</button>
          </div>
          <button id="sessionCopyBtn"       class="session-menu-item" role="menuitem">Copy selection</button>
          <button id="sessionResetBtn"      class="session-menu-item" role="menuitem">Reset terminal</button>
          <button id="sessionClearBtn"      class="session-menu-item" role="menuitem">Clear scrollback</button>
          <button id="sessionRecordStartBtn" class="session-menu-item rec-start" role="menuitem">‚óè Start Recording</button>
          <button id="sessionRecordStopBtn"  class="session-menu-item rec-stop hidden" role="menuitem">‚ñ† Stop &amp; Download</button>
          <div class="session-menu-item ctrl-row" role="group" aria-label="Send control sequences">
            <button id="sessionCtrlCBtn" class="ctrl-btn" role="menuitem">Ctrl+C</button>
            <button id="sessionCtrlZBtn" class="ctrl-btn" role="menuitem">Ctrl+Z</button>
          </div>
          <button id="sessionThemeBtn"      class="session-menu-item" role="menuitem">Theme: Dark ‚ñ∏</button>
          <button id="sessionReconnectBtn"  class="session-menu-item" role="menuitem">Reconnect</button>
          <button id="sessionDisconnectBtn" class="session-menu-item danger" role="menuitem">Disconnect</button>
        </div>
      </div>
      <div id="key-bar">
        <!-- Single row: scrollable special keys + right-anchored compose toggle -->
        <div id="key-keys-row">
          <div id="key-scroll">
            <button id="keyEsc"   class="key-btn" title="Escape">Esc</button>
            <button id="keyCtrl"  class="key-btn modifier" title="Ctrl modifier">Ctl</button>
            <button id="keyTab"   class="key-btn" title="Tab">‚Üπ</button>
            <button id="keySlash" class="key-btn" title="/">/</button>
            <button id="keyPipe"  class="key-btn" title="|">|</button>
            <button id="keyDash"  class="key-btn" title="-">-</button>
            <button id="keyUp"    class="key-btn" title="Up">‚ñ≤</button>
            <button id="keyDown"  class="key-btn" title="Down">‚ñº</button>
            <button id="keyLeft"  class="key-btn" title="Left">‚óÄ</button>
            <button id="keyRight" class="key-btn" title="Right">‚ñ∂</button>
            <button id="keyHome"  class="key-btn" title="Home">Home</button>
            <button id="keyEnd"   class="key-btn" title="End">End</button>
            <button id="keyPgUp"  class="key-btn" title="Page Up">PgUp</button>
            <button id="keyPgDn"  class="key-btn" title="Page Down">PgDn</button>
          </div>
          <button id="composeModeBtn" class="key-btn mode-btn" title="Compose mode: swipe typing, voice, autocorrect"><svg viewBox="0 0 12 20" width="9" height="15" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M8.5 1.5l2 2L4 10l-2.5.5.5-2.5Z"/><line x1="1" y1="14" x2="11" y2="14"/><line x1="1" y1="18" x2="11" y2="18"/></svg></button>
        </div>
      </div>
    </div>

    <!-- Connect panel -->
    <div id="panel-connect" class="panel">
      <h2>Connect</h2>

      <form id="connectForm" autocomplete="off">
        <label for="profileName">Profile name</label>
        <input type="text" id="profileName" placeholder="My Server" />

        <label for="host">Host</label>
        <input type="text" id="host" placeholder="192.168.1.100" required inputmode="url" />

        <label for="port">Port</label>
        <input type="number" id="port" value="22" min="1" max="65535" inputmode="numeric" />

        <label for="username">Username</label>
        <input type="text" id="username" placeholder="root" required autocapitalize="none"
          autocomplete="off"
          data-lpignore="true"
          data-1p-ignore="true"
          data-form-type="other" />

        <label for="authType">Auth method</label>
        <select id="authType">
          <option value="password">Password</option>
          <option value="key">Private key</option>
        </select>

        <div id="passwordGroup">
          <label for="password">Password</label>
          <input type="password" id="password"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            data-lpignore="true"
            data-1p-ignore="true"
            data-form-type="other" />
        </div>

        <div id="keyGroup" style="display:none">
          <label for="privateKey">Private key</label>
          <textarea id="privateKey" rows="4" placeholder="Paste PEM private key here..." spellcheck="false"></textarea>
          <label for="passphrase">Passphrase (if encrypted)</label>
          <input type="password" id="passphrase"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            data-lpignore="true"
            data-1p-ignore="true"
            data-form-type="other" />
          <button type="button" id="useStoredKeyBtn" class="secondary-btn">Use stored key‚Ä¶</button>
        </div>

        <label for="initialCommand">Initial command (optional)</label>
        <input type="text" id="initialCommand"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="none"
          spellcheck="false" />
        <p class="hint">Runs automatically after connecting. Leave blank for a normal shell.</p>

        <button type="submit" class="primary-btn">Connect</button>
      </form>

      <h3>Saved profiles</h3>
      <div id="profileList" class="item-list">
        <p class="empty-hint">No saved profiles yet.</p>
      </div>
    </div>

    <!-- Keys panel -->
    <div id="panel-keys" class="panel">
      <h2>SSH Keys</h2>
      <p class="hint">Import your private keys here. They are stored in your browser's localStorage.
         Do not use this on a shared device.</p>

      <div class="form-section">
        <label for="keyName">Key name</label>
        <input type="text" id="keyName" placeholder="my-key" />

        <label for="keyData">Private key (PEM)</label>
        <textarea id="keyData" rows="6" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" spellcheck="false"></textarea>

        <button id="importKeyBtn" class="primary-btn">Save key</button>
      </div>

      <h3>Stored keys</h3>
      <div id="keyList" class="item-list">
        <p class="empty-hint">No keys stored.</p>
      </div>
    </div>

    <!-- Settings panel -->
    <div id="panel-settings" class="panel">
      <h2>Settings</h2>

      <label for="wsUrl">WebSocket server URL</label>
      <input type="url" id="wsUrl" placeholder="wss://your-server:8080" inputmode="url" />
      <p class="hint">The URL of your ssh-bridge server. Only <code>wss://</code> (TLS) is accepted.
         When running in a Codespace, set this to the forwarded port URL for port 8080 with <code>wss://</code>.</p>
      <p id="wsWarnInsecure" class="hint hidden" style="color: var(--danger);">‚ö† ws:// is unencrypted. Use wss:// for connections over any untrusted network.</p>
      <button id="saveSettingsBtn" class="primary-btn">Save</button>

      <hr />

      <label for="fontSize">Terminal font size</label>
      <input type="range" id="fontSize" min="10" max="24" value="14" />
      <span id="fontSizeValue">14px</span>

      <hr />

      <label for="termThemeSelect">Default terminal theme</label>
      <select id="termThemeSelect">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="solarizedDark">Solarized Dark</option>
        <option value="solarizedLight">Solarized Light</option>
        <option value="highContrast">High Contrast</option>
      </select>
      <p class="hint">Persisted across sessions. Use the session menu to switch themes temporarily during a session.</p>

      <hr />

      <label for="termFontSelect">Terminal font</label>
      <select id="termFontSelect">
        <option value="monospace">System monospace</option>
        <option value="jetbrains">JetBrains Mono</option>
        <option value="firacode">Fira Code</option>
      </select>
      <p class="hint">Requires page reload to take effect.</p>

      <hr />

      <div class="vault-settings">
        <h3 class="vault-settings-title">Vault</h3>
        <p id="vaultStatus" class="vault-status">Not set up</p>
        <div id="vaultActions" class="vault-actions">
          <button id="vaultLockBtn" class="secondary-btn hidden">Lock Now</button>
          <button id="vaultChangePwBtn" class="secondary-btn hidden">Change Master Password</button>
          <button id="vaultEnableBioBtn" class="secondary-btn hidden">Enable Fingerprint Unlock</button>
          <button id="vaultDisableBioBtn" class="secondary-btn hidden">Disable Fingerprint Unlock</button>
          <button id="vaultResetBtn" class="danger-btn hidden">Reset Vault</button>
        </div>
      </div>

      <hr />

      <div class="danger-zone">
        <h3 class="danger-zone-title">Danger Zone</h3>
        <p class="hint">These settings weaken security protections. Only change them if you understand the risks.</p>

        <div class="danger-zone-item">
          <div class="danger-zone-item-info">
            <span class="danger-zone-item-label">Allow <code>ws://</code> (unencrypted)</span>
            <p class="hint">By default, <code>ws://</code> URLs are rejected at save time. Enable to allow them with a warning only. Browsers block <code>ws://</code> on HTTPS pages regardless.</p>
          </div>
          <label class="toggle" aria-label="Allow ws:// connections">
            <input type="checkbox" id="dangerAllowWs" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="danger-zone-item">
          <div class="danger-zone-item-info">
            <span class="danger-zone-item-label">Allow private/loopback addresses</span>
            <p class="hint">‚ö† Disables SSRF protection. Only enable if you need to SSH to RFC-1918 addresses (10.x, 172.16‚Äì31.x, 192.168.x) or localhost.</p>
          </div>
          <label class="toggle" aria-label="Allow private address connections">
            <input type="checkbox" id="allowPrivateHosts" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="danger-zone-item">
          <div class="danger-zone-item-info">
            <span class="danger-zone-item-label">Debug overlay</span>
            <p class="hint">Shows touch/scroll event logs on screen. Tap log to copy.</p>
          </div>
          <label class="toggle" aria-label="Enable debug overlay">
            <input type="checkbox" id="debugOverlay" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="danger-zone-item">
          <div class="danger-zone-item-info">
            <span class="danger-zone-item-label">Enable pinch-to-zoom</span>
            <p class="hint">Two-finger pinch changes terminal font size. Disable if it interferes with scrolling.</p>
          </div>
          <label class="toggle" aria-label="Enable pinch-to-zoom">
            <input type="checkbox" id="enablePinchZoom" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <button id="clearDataBtn" class="danger-btn">Clear all data (keys, profiles, settings)</button>
      <button id="clearCacheBtn" class="danger-btn">Clear cache &amp; reload</button>

      <p id="versionInfo" class="version-info"></p>
    </div>
  </div>

  <!-- Debug overlay ‚Äî shows console output on mobile devices without DevTools -->
  <div id="debugOverlayPanel" class="debug-overlay hidden">
    <div class="debug-overlay-header">
      <span>Debug Log</span>
      <button id="debugCopyBtn" class="debug-overlay-btn">Copy</button>
      <button id="debugClearBtn" class="debug-overlay-btn">Clear</button>
    </div>
    <div id="debugOverlayLog" class="debug-overlay-log"></div>
  </div>

  <!-- Recovery watchdog ‚Äî loaded before app.js so it fires even on init failure.
       Handles ?reset=1 cache-clear and the 8-second boot-health timeout. -->
  <script src="recovery.js"></script>
  <script type="module" src="app.js"></script>
</body>
</html>
